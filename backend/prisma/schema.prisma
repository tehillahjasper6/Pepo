// PEPO Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ════════════════════════════════════════════════════════════════════════════
// ENUMS
// ════════════════════════════════════════════════════════════════════════════

enum UserRole {
  USER
  NGO
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum GiveawayStatus {
  DRAFT
  OPEN
  CLOSED
  COMPLETED
  CANCELLED
}

enum EligibilityGender {
  MALE
  FEMALE
  OTHER
  ALL
}

enum ParticipantStatus {
  INTERESTED
  SELECTED
  REJECTED
  WITHDRAWN
}

enum NotificationType {
  WINNER_SELECTED
  DRAW_CLOSED
  NEW_MESSAGE
  GIVEAWAY_REMINDER
  NGO_VERIFIED
  NGO_NEW_POST
  SYSTEM_ALERT
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum NGOStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
  SUSPENDED
  EXPIRED
}

enum OrganizationType {
  NGO
  CHARITY
  FOUNDATION
  FAITH_BASED
  COMMUNITY_ORG
  OTHER
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  REQUEST_INFO
}

enum ReportStatus {
  PENDING
  INVESTIGATING
  RESOLVED
  DISMISSED
}

enum TransparencyReportStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum ReportFrequency {
  QUARTERLY
  ANNUAL
}

enum FocusArea {
  EDUCATION
  HEALTH
  RELIEF
  WOMEN
  YOUTH
  ENVIRONMENT
  OTHER
}

enum ConfidenceLevel {
  EMERGING
  TRUSTED
  HIGHLY_TRUSTED
}

// ════════════════════════════════════════════════════════════════════════════
// USER MODELS
// ════════════════════════════════════════════════════════════════════════════

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  emailVerified Boolean  @default(false)
  passwordHash  String?
  name          String
  avatar        String?
  city          String?
  phone         String?  @unique
  phoneVerified Boolean  @default(false)
  gender        Gender   @default(PREFER_NOT_TO_SAY)
  role          UserRole @default(USER)
  isActive      Boolean  @default(true)

  // OAuth
  googleId String? @unique
  appleId  String? @unique

  // Gamification
  gamificationPoints Int @default(0)

  // Identity Verification
  idVerified Boolean @default(false)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  giveaways               Giveaway[]
  participations          Participant[]
  sentMessages            Message[]                @relation("SentMessages")
  receivedMessages        Message[]                @relation("ReceivedMessages")
  notifications           Notification[]
  reports                 Report[]                 @relation("ReportedBy")
  reportedReports         Report[]                 @relation("ReportedUser")
  winners                 Winner[]
  ngoProfile              NGOProfile?
  verifiedNGOs            NGOProfile[]             @relation("VerifiedNGOs")
  ngoReviews              NGOReview[]              @relation("NGOReviews")
  ngoFeedback             NGOFeedback[]            @relation("NGOFeedback")
  auditLogs               AuditLog[]
  otpCodes                OTPCode[]
  deviceTokens            DeviceToken[]
  badgeAssignments        BadgeAssignment[]
  trustScore              TrustScore?
  givenFeedback           TransactionFeedback[]    @relation("FeedbackGiver")
  receivedFeedback        TransactionFeedback[]    @relation("FeedbackReceiver")
  fraudFlags              FraudFlag[]
  fraudReviews            FraudFlag[]              @relation("FraudReviewer")
  environmentalImpact     EnvironmentalImpact?
  smartMatches            SmartMatchingScore[]
  follows                 Follow[]
  notificationPreferences NotificationPreference[]
  digestPreference        UserDigestPreference?
  campaignReminderLogs    CampaignReminderLog[]
  followSuggestions       FollowSuggestion[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model OTPCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@map("otp_codes")
}

// ════════════════════════════════════════════════════════════════════════════
// NGO MODELS
// ════════════════════════════════════════════════════════════════════════════

model NGOProfile {
  id     String @id @default(uuid())
  userId String @unique

  // Organization Details
  organizationName   String
  organizationType   OrganizationType
  country            String
  city               String
  address            String
  yearEstablished    Int?
  registrationNumber String           @unique
  taxExemptionId     String?
  website            String?
  officialEmail      String
  officialPhone      String

  // Primary Contact
  contactName       String
  contactRole       String
  contactEmail      String
  contactPhone      String
  contactNationalId String?

  // Verification
  status           NGOStatus @default(PENDING_VERIFICATION)
  verifiedAt       DateTime?
  verifiedBy       String?
  verifiedByUserId String?
  verifiedByUser   User?     @relation("VerifiedNGOs", fields: [verifiedByUserId], references: [id])
  rejectionReason  String?
  expiresAt        DateTime? // Annual re-validation

  // Impact metrics
  totalGiveaways     Int   @default(0)
  totalBeneficiaries Int   @default(0)
  trustScore         Float @default(0.0)

  // Public Profile Fields
  logo                       String?
  missionStatement           String?
  focusAreas                 FocusArea[]
  hasGovernmentRecognition   Boolean     @default(false)
  governmentRecognitionBadge String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaigns               Campaign[]
  documents               NGODocument[]
  reviews                 NGOReview[]
  pickupPoints            PickupPoint[]
  transparencyReports     NGOTransparencyReport[]
  confidenceScores        NGOConfidenceScore[]
  feedback                NGOFeedback[]
  badgeAssignments        BadgeAssignment[]
  followers               Follow[]
  notificationPreferences NotificationPreference[]
  suggestedToUsers        FollowSuggestion[]

  @@index([status])
  @@index([registrationNumber])
  @@index([country])
  @@map("ngo_profiles")
}

model NGODocument {
  id           String   @id @default(uuid())
  ngoProfileId String
  documentType String // REGISTRATION_CERTIFICATE, TAX_EXEMPTION, NATIONAL_ID, OTHER
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  uploadedAt   DateTime @default(now())

  ngoProfile NGOProfile @relation(fields: [ngoProfileId], references: [id], onDelete: Cascade)

  @@index([ngoProfileId])
  @@index([documentType])
  @@map("ngo_documents")
}

model NGOReview {
  id            String       @id @default(uuid())
  ngoProfileId  String
  reviewerId    String
  status        ReviewStatus @default(PENDING)
  notes         String?
  riskFlags     Json? // Array of risk flags
  requestedInfo String? // If REQUEST_INFO status
  reviewedAt    DateTime     @default(now())

  ngoProfile NGOProfile @relation(fields: [ngoProfileId], references: [id], onDelete: Cascade)
  reviewer   User       @relation("NGOReviews", fields: [reviewerId], references: [id])

  @@index([ngoProfileId])
  @@index([reviewerId])
  @@index([status])
  @@map("ngo_reviews")
}

model PickupPoint {
  id           String   @id @default(uuid())
  ngoProfileId String
  name         String
  address      String
  city         String
  country      String
  latitude     Float?
  longitude    Float?
  contactPhone String?
  hours        String? // Operating hours
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ngoProfile NGOProfile @relation(fields: [ngoProfileId], references: [id], onDelete: Cascade)
  pickups    Pickup[]

  @@index([ngoProfileId])
  @@index([isActive])
  @@map("pickup_points")
}

// ════════════════════════════════════════════════════════════════════════════
// NGO TRUST FRAMEWORK MODELS
// ════════════════════════════════════════════════════════════════════════════

model NGOTransparencyReport {
  id           String @id @default(uuid())
  ngoProfileId String

  // Reporting Period
  reportFrequency ReportFrequency
  periodStart     DateTime
  periodEnd       DateTime

  // Campaign Summary
  campaignCount    Int      @default(0)
  itemsDistributed Int      @default(0)
  locationsServed  String[] // Array of locations

  // Financial Summary (optional, range-based)
  fundsReceivedMin Float?
  fundsReceivedMax Float?
  fundsUtilized    Json? // Categories breakdown

  // Impact Metrics
  beneficiariesReached Int   @default(0)
  successStories       Json? // Array of {title, description, images[]}

  // Challenges & Lessons
  challenges     String?
  lessonsLearned String?

  // Supporting Documents
  supportingDocuments String[] // Array of file URLs

  // Status & Review
  status          TransparencyReportStatus @default(DRAFT)
  submittedAt     DateTime?
  reviewedAt      DateTime?
  reviewedBy      String?
  reviewNotes     String?
  rejectionReason String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ngoProfile NGOProfile @relation(fields: [ngoProfileId], references: [id], onDelete: Cascade)

  @@index([ngoProfileId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("ngo_transparency_reports")
}

model NGOConfidenceScore {
  id           String @id @default(uuid())
  ngoProfileId String

  // Score Components (0-100)
  verificationScore Float @default(0) // Baseline: verified = 30
  transparencyScore Float @default(0) // Report consistency: 0-25
  activityScore     Float @default(0) // Recent activity: 0-20
  completionScore   Float @default(0) // Campaign completion: 0-15
  feedbackScore     Float @default(0) // User feedback: 0-10

  // Additional Factors
  hasGovernmentRecognition Boolean @default(false) // +5 bonus
  adminTrustFlags          Int     @default(0) // -5 to +5 adjustment

  // Calculated Score
  totalScore      Float           @default(0)
  confidenceLevel ConfidenceLevel @default(EMERGING)

  // Metadata
  calculatedAt     DateTime @default(now())
  factorsBreakdown Json? // Detailed breakdown for audit

  // Relations
  ngoProfile NGOProfile @relation(fields: [ngoProfileId], references: [id], onDelete: Cascade)

  @@index([ngoProfileId])
  @@index([calculatedAt])
  @@index([totalScore])
  @@map("ngo_confidence_scores")
}

// ════════════════════════════════════════════════════════════════════════════
// BADGE SYSTEM MODELS
// ════════════════════════════════════════════════════════════════════════════

model BadgeDefinition {
  id          String   @id @default(uuid())
  code        String   @unique // machine friendly id (e.g. FIRST_GIVER)
  name        String
  description String
  criteria    Json? // structured criteria for audit and docs
  icon        String? // icon path or identifier
  color       String? // hex or token name
  isNGO       Boolean  @default(false) // if badge applies to NGO profiles
  isAutoAward Boolean  @default(true) // whether system can auto-award
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments BadgeAssignment[]

  @@map("badge_definitions")
}

model BadgeAssignment {
  id           String   @id @default(uuid())
  badgeId      String
  userId       String?
  ngoProfileId String?
  giveawayId   String?
  awardedById  String? // admin user id if awarded manually by admin
  awardedAt    DateTime @default(now())
  reason       String? // optional reason or evidence
  isRevoked    Boolean  @default(false)

  badge      BadgeDefinition @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user       User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  ngoProfile NGOProfile?     @relation(fields: [ngoProfileId], references: [id], onDelete: Cascade)

  @@unique([badgeId, userId], name: "unique_badge_user")
  @@unique([badgeId, ngoProfileId], name: "unique_badge_ngo")
  @@index([userId])
  @@index([ngoProfileId])
  @@index([badgeId])
  @@map("badge_assignments")
}

// ════════════════════════════════════════════════════════════════════════════
// TRUST & FEEDBACK SYSTEM
// ════════════════════════════════════════════════════════════════════════════

model TrustScore {
  id                 String   @id @default(uuid())
  userId             String   @unique
  givingScore        Float    @default(0) // 0-100: based on successful gives
  receivingScore     Float    @default(0) // 0-100: based on successful receives
  feedbackScore      Float    @default(0) // 0-100: community feedback average
  completionRate     Float    @default(0) // 0-100: % of started vs completed
  responseTime       Float    @default(0) // hours average to respond
  totalScore         Float    @default(0) // 0-100: weighted average
  trustLevel         String   @default("NEW") // NEW, EMERGING, TRUSTED, HIGHLY_TRUSTED
  successfulGives    Int      @default(0)
  successfulReceives Int      @default(0)
  totalInteractions  Int      @default(0)
  negativeReports    Int      @default(0) // Count of reports against user
  calculatedAt       DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([totalScore])
  @@index([trustLevel])
  @@map("trust_scores")
}

model TransactionFeedback {
  id                   String   @id @default(uuid())
  giverId              String
  receiverId           String
  giveawayId           String
  itemCondition        String   @default("as-described") // as-described, better, worse
  communicationQuality String   @default("good") // excellent, good, poor
  wouldRecommend       Boolean  @default(true)
  comments             String?
  rating               Int      @default(5) // 1-5 stars
  flagged              Boolean  @default(false) // if inappropriate
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  giver    User     @relation("FeedbackGiver", fields: [giverId], references: [id], onDelete: Cascade)
  receiver User     @relation("FeedbackReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  giveaway Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)

  @@unique([giverId, receiverId, giveawayId], name: "unique_transaction_feedback")
  @@index([giverId])
  @@index([receiverId])
  @@index([giveawayId])
  @@index([flagged])
  @@map("transaction_feedback")
}

model FraudFlag {
  id          String    @id @default(uuid())
  userId      String
  riskScore   Float     @default(0) // 0-100
  flagType    String // rapid_giveaway, new_account_spike, multiple_reports
  description String
  action      String    @default("none") // none, warning, review, suspend
  reviewedAt  DateTime?
  reviewedBy  String?
  resolution  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewAdmin User? @relation("FraudReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([riskScore])
  @@index([action])
  @@map("fraud_flags")
}

model EnvironmentalImpact {
  id                     String   @id @default(uuid())
  userId                 String   @unique
  estimatedCO2Saved      Float    @default(0) // kg
  estimatedWasteDiverted Float    @default(0) // kg
  itemsCategoryBreakdown Json? // { category: count }
  updatedAt              DateTime @updatedAt
  createdAt              DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("environmental_impact")
}

model SmartMatchingScore {
  id               String   @id @default(uuid())
  userId           String
  giveawayId       String
  matchScore       Float    @default(0) // 0-100
  proximity        Float    @default(0) // distance factor
  categoryMatch    Float    @default(0) // category interest
  timeAvailability Float    @default(0) // time match
  trustAlignment   Float    @default(0) // giver trust score alignment
  calculatedAt     DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  giveaway Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)

  @@unique([userId, giveawayId], name: "unique_match_score")
  @@index([userId])
  @@index([giveawayId])
  @@index([matchScore])
  @@map("smart_matching_scores")
}

model NGOFeedback {
  id           String @id @default(uuid())
  ngoProfileId String
  userId       String

  // Feedback (qualitative, not star-based)
  feedbackText String
  isPositive   Boolean @default(true)

  // Context
  relatedGiveawayId String?
  relatedCampaignId String?

  // Moderation
  isApproved  Boolean   @default(false)
  moderatedAt DateTime?
  moderatedBy String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ngoProfile NGOProfile @relation(fields: [ngoProfileId], references: [id], onDelete: Cascade)
  user       User       @relation("NGOFeedback", fields: [userId], references: [id], onDelete: Cascade)

  @@index([ngoProfileId])
  @@index([userId])
  @@index([isApproved])
  @@map("ngo_feedback")
}

model Pickup {
  id            String    @id @default(uuid())
  winnerId      String    @unique
  pickupPointId String?
  pickupCode    String    @unique
  qrCodeUrl     String?
  scheduledAt   DateTime?
  completedAt   DateTime?
  verifiedBy    String? // Admin/NGO user who verified
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  winner      Winner       @relation(fields: [winnerId], references: [id], onDelete: Cascade)
  pickupPoint PickupPoint? @relation(fields: [pickupPointId], references: [id], onDelete: SetNull)

  @@index([pickupCode])
  @@index([pickupPointId])
  @@map("pickups")
}

model Campaign {
  id           String  @id @default(uuid())
  ngoProfileId String
  title        String
  description  String
  slug         String  @unique
  coverImage   String?

  // Schedule
  startDate     DateTime?
  endDate       DateTime?
  isRecurring   Boolean   @default(false)
  recurringRule Json?

  // Metrics
  totalGiveaways Int @default(0)
  totalReached   Int @default(0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ngoProfile             NGOProfile                @relation(fields: [ngoProfileId], references: [id], onDelete: Cascade)
  giveaways              Giveaway[]
  reminderSettings       CampaignReminderSetting[]
  campaignReminderLogs   CampaignReminderLog[]

  @@index([ngoProfileId])
  @@index([slug])
  @@map("campaigns")
}

// ════════════════════════════════════════════════════════════════════════════
// GIVEAWAY MODELS
// ════════════════════════════════════════════════════════════════════════════

model Giveaway {
  id         String  @id @default(uuid())
  userId     String
  campaignId String?

  title       String
  description String
  images      String[]
  category    String?
  location    String

  // Eligibility
  eligibilityGender EligibilityGender @default(ALL)
  eligibilityAgeMin Int?
  eligibilityAgeMax Int?

  // Quantity & Distribution
  quantity     Int @default(1)
  winnersCount Int @default(0)

  // Status & Timing
  status      GiveawayStatus @default(DRAFT)
  publishedAt DateTime?
  expiresAt   DateTime?
  closedAt    DateTime?

  // Draw
  drawCompletedAt DateTime?
  drawLockKey     String?   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign     Campaign?             @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  participants Participant[]
  winners      Winner[]
  messages     Message[]
  feedback     TransactionFeedback[]
  smartMatches SmartMatchingScore[]

  @@index([userId])
  @@index([status])
  @@index([campaignId])
  @@index([closedAt])
  @@map("giveaways")
}

model Participant {
  id         String            @id @default(uuid())
  userId     String
  giveawayId String
  status     ParticipantStatus @default(INTERESTED)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  giveaway Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)

  @@unique([userId, giveawayId])
  @@index([giveawayId])
  @@index([status])
  @@map("participants")
}

model Winner {
  id         String   @id @default(uuid())
  giveawayId String
  userId     String
  drawNumber Int      @default(1)
  selectedAt DateTime @default(now())

  giveaway Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)
  pickup   Pickup?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([giveawayId, userId, drawNumber])
  @@index([giveawayId])
  @@map("winners")
}

// ════════════════════════════════════════════════════════════════════════════
// MESSAGING
// ════════════════════════════════════════════════════════════════════════════

model Message {
  id         String        @id @default(uuid())
  giveawayId String
  senderId   String
  receiverId String
  content    String
  status     MessageStatus @default(SENT)
  readAt     DateTime?
  createdAt  DateTime      @default(now())

  giveaway Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)
  sender   User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([giveawayId])
  @@index([senderId])
  @@index([receiverId])
  @@map("messages")
}

// ════════════════════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ════════════════════════════════════════════════════════════════════════════

model Notification {
  id          String           @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  referenceId String? // e.g. giveaway id
  link        String? // deep link to resource
  data        Json?
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  token     String // JSON stringified push subscription
  platform  String   @default("web") // web, ios, android
  deviceId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([platform])
  @@map("device_tokens")
}

// ════════════════════════════════════════════════════════════════════════════
// REPORTS & MODERATION
// ════════════════════════════════════════════════════════════════════════════

model Report {
  id           String       @id @default(uuid())
  reportedBy   String
  reportedUser String?
  giveawayId   String?
  reason       String
  description  String?
  status       ReportStatus @default(PENDING)
  resolvedAt   DateTime?
  resolvedBy   String?
  resolution   String?
  createdAt    DateTime     @default(now())

  reporter User  @relation("ReportedBy", fields: [reportedBy], references: [id], onDelete: Cascade)
  reported User? @relation("ReportedUser", fields: [reportedUser], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([reportedBy])
  @@map("reports")
}

// ════════════════════════════════════════════════════════════════════════════
// AUDIT & LOGGING
// ════════════════════════════════════════════════════════════════════════════

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// Follow relationships (users -> ngo profiles)
model Follow {
  id        String   @id @default(uuid())
  userId    String
  ngoId     String
  createdAt DateTime @default(now())

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  ngo  NGOProfile @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  @@unique([userId, ngoId])
  @@index([userId])
  @@index([ngoId])
  @@map("follows")
}

// ════════════════════════════════════════════════════════════════════════════
// DIGEST & REMINDER NOTIFICATION MODELS
// ════════════════════════════════════════════════════════════════════════════

enum DigestFrequency {
  DAILY
  WEEKLY
}

enum DigestChannel {
  IN_APP
  EMAIL
  PUSH
}

// User digest notification preferences
model UserDigestPreference {
  id                String          @id @default(uuid())
  userId            String
  frequency         DigestFrequency @default(DAILY)
  isEnabled         Boolean         @default(true)
  channels          DigestChannel[] @default([IN_APP])
  lastDigestSentAt  DateTime?
  nextScheduledAt   DateTime?
  includeNewPosts   Boolean         @default(true)
  includeCampaigns  Boolean         @default(true)
  includeCompleted  Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
  @@index([nextScheduledAt])
  @@map("user_digest_preferences")
}

enum ReminderType {
  CAMPAIGN_LAUNCH_SOON
  CAMPAIGN_ENDING
  CAMPAIGN_LAUNCH_7DAYS
  CAMPAIGN_LAUNCH_24HOURS
  CAMPAIGN_LAUNCH_SAME_DAY
}

// Campaign reminder settings
model CampaignReminderSetting {
  id                String       @id @default(uuid())
  campaignId        String
  reminderType      ReminderType
  isEnabled         Boolean      @default(true)
  sentAt            DateTime?
  nextReminderAt    DateTime?
  cooldownMinutes   Int          @default(60)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, reminderType])
  @@index([campaignId])
  @@index([nextReminderAt])
  @@map("campaign_reminder_settings")
}

// Track sent campaign reminders to prevent duplicates
model CampaignReminderLog {
  id        String   @id @default(uuid())
  userId    String
  campaignId String
  reminderType ReminderType
  sentAt    DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([userId, campaignId, reminderType])
  @@index([userId])
  @@index([campaignId])
  @@index([sentAt])
  @@map("campaign_reminder_logs")
}

// Follow suggestions based on user behavior
model FollowSuggestion {
  id                String   @id @default(uuid())
  userId            String
  suggestedNGOId    String
  confidenceScore   Float    @default(0.5)
  reason            String? // "category_match", "popular_ngo", "location_based", etc.
  signalWeight      Json? // Weighted signals used for ranking
  isViewed          Boolean  @default(false)
  isFollowed        Boolean  @default(false)
  isIgnored         Boolean  @default(false)
  viewedAt          DateTime?
  createdAt         DateTime @default(now())
  expiresAt         DateTime? // Suggestion expires after a certain period

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  ngo  NGOProfile  @relation(fields: [suggestedNGOId], references: [id], onDelete: Cascade)

  @@unique([userId, suggestedNGOId])
  @@index([userId])
  @@index([suggestedNGOId])
  @@index([confidenceScore, createdAt])
  @@map("follow_suggestions")
}

// Notification preferences: global or per-ngo
model NotificationPreference {
  id        String           @id @default(uuid())
  userId    String
  ngoId     String? // null = global preference
  type      NotificationType
  isEnabled Boolean          @default(true)
  createdAt DateTime         @default(now())

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  ngo  NGOProfile? @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  @@unique([userId, ngoId, type])
  @@index([userId])
  @@index([ngoId])
  @@map("notification_preferences")
}
